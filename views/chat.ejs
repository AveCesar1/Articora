<%- include('partials/header', { 
    title: 'Chat - Artícora', 
    currentPage: 'chat',
    cssFile: 'chat.css'
}) %>

<div class="chat-main-container">
    <div class="chat-layout">
        <!-- Panel izquierdo más compacto -->
        <div class="chat-sidebar">
            <!-- Perfil del usuario -->
            <div class="user-profile-card">
                <div class="d-flex align-items-center">
                    <div class="position-relative me-3">
                        <img src="<%= data.user.avatar %>" alt="Avatar" class="avatar rounded-circle">
                        <span class="status-indicator <%= data.user.status %>"></span>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-0 text-truncate"><%= data.user.name %></h6>
                        <small class="text-muted">
                            <span class="badge <%= data.user.type === 'validated' ? 'bg-success' : 'bg-secondary' %>">
                                <i class="fas fa-<%= data.user.type === 'validated' ? 'shield-alt' : 'user' %> me-1"></i>
                                <%= data.user.type === 'validated' ? 'Validado' : 'Registrado' %>
                            </span>
                        </small>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" id="newChatBtn" title="Nueva conversación">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
                
                <!-- Indicadores de límites -->
                <div class="limits-info mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="text-muted">
                            <i class="fas fa-file-upload me-1"></i>
                            Archivos: <%= data.user.fileUploadsThisWeek %>/<%= data.user.fileUploadLimit %>
                        </small>
                        <div class="progress" style="width: 60px; height: 4px;">
                            <div class="progress-bar bg-info" 
                                 style="width: <%= (data.user.fileUploadsThisWeek / data.user.fileUploadLimit * 100) %>%"></div>
                        </div>
                    </div>
                    <% if (data.user.canCreateGroups) { %>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="fas fa-users me-1"></i>
                            Grupos: <%= data.user.currentGroups %>/<%= data.user.maxGroups %>
                        </small>
                    </div>
                    <% } %>
                </div>
            </div>

            <!-- Barra de búsqueda -->
            <div class="sidebar-search">
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-transparent border-end-0">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" class="form-control border-start-0" placeholder="Buscar...">
                </div>
            </div>

            <!-- Navegación rápida -->
            <div class="sidebar-nav">
                <div class="nav-tabs">
                    <button class="nav-tab active" data-target="contacts">
                        <i class="fas fa-user-friends"></i>
                        <span>Contactos</span>
                        <% if (data.pendingRequests.length > 0) { %>
                        <span class="badge bg-danger"><%= data.pendingRequests.length %></span>
                        <% } %>
                    </button>
                    <button class="nav-tab" data-target="groups">
                        <i class="fas fa-users"></i>
                        <span>Grupos</span>
                    </button>
                    <button class="nav-tab" data-target="requests">
                        <i class="fas fa-user-plus"></i>
                        <span>Solicitudes</span>
                    </button>
                    <button class="nav-tab" data-target="articora">
                        <i class="fas fa-bullhorn"></i>
                        <span>Artícora</span>
                        <span class="badge bg-warning text-dark">3</span>
                    </button>
                </div>
            </div>

            <!-- Listas -->
            <div class="sidebar-content">
                <!-- Contactos -->
                <div class="tab-content active" id="contacts-tab">
                    <div class="list-header">
                        <small class="text-uppercase text-muted">Contactos confirmados</small>
                        <span class="badge bg-light text-dark"><%= data.contacts.filter(c => c.isContact).length %></span>
                    </div>
                    <div class="contact-list">
                        <% data.contacts.filter(c => c.isContact).forEach(contact => { %>
                        <div class="contact-item <%= contact.id === data.activeChat.id && data.activeChat.type === 'individual' ? 'active' : '' %>" 
                             data-contact-id="<%= contact.id %>">
                            <div class="d-flex align-items-center">
                                <div class="position-relative me-3">
                                    <img src="<%= contact.avatar %>" alt="Avatar" class="avatar-sm rounded-circle">
                                    <span class="status-indicator <%= contact.status %>"></span>
                                </div>
                                <div class="flex-grow-1 text-truncate">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <strong class="contact-name"><%= contact.name %></strong>
                                        <% if (contact.unread > 0) { %>
                                        <span class="badge bg-primary rounded-pill"><%= contact.unread %></span>
                                        <% } %>
                                    </div>
                                    <small class="text-muted text-truncate d-block">
                                        <span class="badge <%= contact.type === 'validated' ? 'bg-success' : 'bg-secondary' %> me-1">
                                            <%= contact.type === 'validated' ? 'V' : 'R' %>
                                        </span>
                                        <%= contact.lastSeen %>
                                    </small>
                                </div>
                            </div>
                        </div>
                        <% }) %>
                        
                        <% if (data.contacts.filter(c => !c.isContact).length > 0) { %>
                        <div class="list-header mt-3">
                            <small class="text-uppercase text-muted">Solicitudes pendientes</small>
                        </div>
                        <% data.contacts.filter(c => !c.isContact).forEach(contact => { %>
                        <div class="contact-item pending">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <img src="<%= contact.avatar %>" alt="Avatar" class="avatar-sm rounded-circle me-3">
                                    <div class="text-truncate">
                                        <strong><%= contact.name %></strong>
                                        <small class="text-muted d-block">Solicitud pendiente</small>
                                    </div>
                                </div>
                                <div class="btn-group btn-group-sm opacity-0">
                                    <button class="btn btn-outline-success" title="Aceptar">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" title="Rechazar">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <% }) %>
                        <% } %>
                    </div>
                </div>

                <!-- Grupos -->
                <div class="tab-content" id="groups-tab">
                    <% if (data.user.canCreateGroups) { %>
                    <div class="mb-3">
                        <button class="btn btn-primary w-100 btn-sm" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                            <i class="fas fa-plus-circle me-2"></i> Nuevo grupo
                        </button>
                    </div>
                    <% } %>
                    
                    <div class="list-header">
                        <small class="text-uppercase text-muted">Mis grupos</small>
                        <span class="badge bg-light text-dark"><%= data.groups.filter(g => g.isMember).length %></span>
                    </div>
                    <div class="group-list">
                        <% data.groups.filter(g => g.isMember).forEach(group => { %>
                        <div class="group-item <%= group.id === data.activeChat.id && data.activeChat.type === 'group' ? 'active' : '' %>"
                             data-group-id="<%= group.id %>">
                            <div class="d-flex align-items-center">
                                <img src="<%= group.avatar %>" alt="Avatar" class="avatar-sm rounded-circle me-3">
                                <div class="flex-grow-1 text-truncate">
                                    <strong><%= group.name %></strong>
                                    <small class="text-muted d-block">
                                        <i class="fas fa-users me-1"></i>
                                        <%= group.members %>/<%= group.maxMembers %>
                                        <% if (group.lastMessage) { %>
                                        • <%= group.lastMessage.sender %>: <%= group.lastMessage.text %>
                                        <% } %>
                                    </small>
                                </div>
                            </div>
                        </div>
                        <% }) %>
                    </div>
                </div>

                <!-- Solicitudes -->
                <div class="tab-content" id="requests-tab">
                    <% if (data.pendingRequests.length === 0) { %>
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-2x text-muted mb-3"></i>
                        <p class="text-muted">No hay solicitudes pendientes</p>
                    </div>
                    <% } else { %>
                    <div class="request-list">
                        <% data.pendingRequests.forEach(request => { %>
                        <div class="request-item">
                            <div class="d-flex align-items-start mb-3">
                                <img src="<%= request.avatar %>" alt="Avatar" class="avatar-sm rounded-circle me-3">
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <strong><%= request.name %></strong>
                                            <small class="text-muted d-block">
                                                <span class="badge <%= request.type === 'validated' ? 'bg-success' : 'bg-secondary' %>">
                                                    <%= request.type === 'validated' ? 'Validado' : 'Registrado' %>
                                                </span>
                                                <span class="ms-2"><%= request.time %></span>
                                            </small>
                                        </div>
                                    </div>
                                    <p class="request-message mb-2"><%= request.message %></p>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-success btn-sm accept-request">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm reject-request">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm">
                                            <i class="fas fa-flag"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <% }) %>
                    </div>
                    <% } %>
                </div>

                <!-- Canal Artícora -->
                <div class="tab-content" id="articora-tab">
                    <div class="channel-header">
                        <div class="d-flex align-items-center mb-3">
                            <div class="channel-icon me-3">
                                <i class="fas fa-bullhorn text-warning"></i>
                            </div>
                            <div>
                                <h6 class="mb-0">Canal oficial Artícora</h6>
                                <small class="text-muted">Anuncios y notificaciones</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="channel-messages">
                        <% data.articoraChannel.messages.forEach(message => { %>
                        <div class="channel-message <%= message.isAnnouncement ? 'announcement' : '' %>">
                            <div class="d-flex align-items-start mb-2">
                                <i class="fas fa-<%= message.isAnnouncement ? 'bullhorn' : 'info-circle' %> 
                                    <%= message.isAnnouncement ? 'text-warning' : 'text-info' %> me-2 mt-1"></i>
                                <div class="flex-grow-1">
                                    <p class="mb-1"><%= message.text %></p>
                                    <small class="text-muted">
                                        <i class="far fa-clock me-1"></i>
                                        <%= message.time %>
                                    </small>
                                </div>
                            </div>
                        </div>
                        <% }) %>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel principal de chat -->
        <div class="chat-main">
            <!-- Encabezado del chat -->
            <div class="chat-header">
                <div class="d-flex align-items-center">
                    <% if (data.activeChat.type === 'individual') { %>
                    <div class="position-relative me-3">
                        <img src="<%= data.contacts.find(c => c.id === data.activeChat.id)?.avatar || data.user.avatar %>" 
                             alt="Avatar" class="avatar rounded-circle">
                        <span class="status-indicator <%= data.activeChat.status %>"></span>
                    </div>
                    <div>
                        <h5 class="mb-0"><%= data.activeChat.name %></h5>
                        <small class="text-muted">
                            <% if (data.activeChat.encryption) { %>
                            <i class="fas fa-lock text-success me-1" title="Cifrado activo"></i>
                            <% } %>
                            <%= data.activeChat.status === 'online' ? 'En línea' : 'Desconectado' %>
                        </small>
                    </div>
                    <% } else if (data.activeChat.type === 'group') { %>
                    <div class="me-3">
                        <i class="fas fa-users fa-2x text-primary"></i>
                    </div>
                    <div>
                        <h5 class="mb-0"><%= data.activeChat.name %></h5>
                        <small class="text-muted">
                            <i class="fas fa-users me-1"></i> Grupo académico
                        </small>
                    </div>
                    <% } else if (data.activeChat.type === 'channel') { %>
                    <div class="me-3">
                        <i class="fas fa-bullhorn fa-2x text-warning"></i>
                    </div>
                    <div>
                        <h5 class="mb-0">Canal Artícora</h5>
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i> Anuncios oficiales
                        </small>
                    </div>
                    <% } %>
                </div>
                
                <div class="chat-actions">
                    <% if (data.activeChat.type === 'individual' || data.activeChat.type === 'group') { %>
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Información">
                        <i class="fas fa-info-circle"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Llamada">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#reportModal">
                        <i class="fas fa-flag"></i>
                    </button>
                    <% } %>
                </div>
            </div>

            <!-- Área de mensajes -->
            <div class="messages-area" id="messagesContainer">
                <% if (data.activeChat.type === 'channel') { %>
                <!-- Mensajes del canal -->
                <div class="text-center mb-4">
                    <div class="channel-welcome">
                        <i class="fas fa-bullhorn fa-3x text-warning mb-3"></i>
                        <h4>Canal oficial Artícora</h4>
                        <p class="text-muted">Aquí encontrarás anuncios y notificaciones importantes</p>
                    </div>
                </div>
                
                <% data.articoraChannel.messages.forEach(message => { %>
                <div class="channel-message-card">
                    <div class="d-flex">
                        <div class="message-icon me-3">
                            <i class="fas fa-<%= message.isAnnouncement ? 'bullhorn' : 'info-circle' %> fa-lg
                                <%= message.isAnnouncement ? 'text-warning' : 'text-info' %>"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <strong><%= message.sender %></strong>
                                <small class="text-muted"><%= message.time %></small>
                            </div>
                            <p class="mb-0"><%= message.text %></p>
                        </div>
                    </div>
                </div>
                <% }) %>
                
                <% } else { %>
                <!-- Mensajes normales -->
                <% data.activeChat.messages.forEach(message => { %>
                <div class="message <%= message.isOwn ? 'own' : '' %>" data-message-id="<%= message.id %>">
                    <% if (!message.isOwn && data.activeChat.type === 'group') { %>
                    <small class="message-sender"><%= message.sender %></small>
                    <% } %>
                    
                    <div class="message-content">
                        <div class="message-bubble">
                            <% if (message.file) { %>
                            <div class="file-message">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-file-<%= message.file.type === 'pdf' ? 'pdf' : 'word' %> fa-2x me-3" 
                                       style="color: <%= message.file.type === 'pdf' ? '#e74c3c' : '#2c3e50' %>"></i>
                                    <div class="flex-grow-1">
                                        <strong><%= message.file.name %></strong>
                                        <div class="text-muted small"><%= message.file.size %></div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </div>
                                <% if (message.text) { %>
                                <p class="mb-0"><%= message.text %></p>
                                <% } %>
                            </div>
                            <% } else { %>
                            <p class="mb-0"><%= message.text %></p>
                            <% } %>
                        </div>
                        
                        <div class="message-footer">
                            <small class="text-muted"><%= message.time %></small>
                            <% if (message.isOwn) { %>
                            <div class="message-status">
                                <% if (message.status === 'sent') { %>
                                <i class="fas fa-check text-muted"></i>
                                <% } else if (message.status === 'delivered') { %>
                                <i class="fas fa-check-double text-muted"></i>
                                <% } else if (message.status === 'read') { %>
                                <i class="fas fa-check-double text-primary"></i>
                                <% } %>
                            </div>
                            <% } %>
                        </div>
                    </div>
                </div>
                <% }) %>
                
                <!-- Indicador de cifrado -->
                <div class="encryption-notice">
                    <i class="fas fa-lock text-success me-2"></i>
                    <small class="text-muted">
                        Los mensajes están protegidos con cifrado de extremo a extremo (AES-256 & RSA-2048)
                    </small>
                </div>
                <% } %>
            </div>

            <!-- Área de entrada -->
            <% if (data.activeChat.type !== 'channel') { %>
            <div class="message-input-area">
                <div class="character-counter mb-2 d-none" id="characterCounter">
                    <div class="progress" style="height: 2px;">
                        <div class="progress-bar" id="characterProgress" style="width: 0%"></div>
                    </div>
                    <small class="text-muted">
                        <span id="characterCount">0</span>/2100 caracteres
                    </small>
                </div>
                
                <form id="messageForm" class="message-form">
                    <div class="input-wrapper">
                        <textarea class="form-control message-input" id="messageInput" 
                                  placeholder="Escribe tu mensaje..." 
                                  rows="1"></textarea>
                        
                        <div class="input-actions">
                            <button type="button" class="btn btn-sm btn-outline-secondary" 
                                    data-bs-toggle="modal" data-bs-target="#uploadModal"
                                    data-bs-toggle="tooltip" title="Adjuntar archivo">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                    data-bs-toggle="tooltip" title="Formatear texto">
                                <i class="fas fa-bold"></i>
                            </button>
                            <button type="submit" class="btn btn-primary send-button">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="input-info">
                        <small class="text-muted">
                            <i class="fas fa-shield-alt me-1"></i>
                            Cifrado activo
                        </small>
                        <small class="text-muted">
                            <i class="fas fa-file-upload me-1"></i>
                            Límite: 5MB por archivo
                        </small>
                    </div>
                </form>
            </div>
            <% else { %>
            <div class="channel-info">
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Este es un canal de solo lectura. Solo los administradores pueden publicar anuncios.
                </div>
            </div>
            <% } %>
        </div>
    </div>
</div>

<!-- Modales (sin cambios) -->
<div class="modal fade" id="createGroupModal" tabindex="-1">
    <!-- Contenido del modal igual que antes -->
</div>

<div class="modal fade" id="uploadModal" tabindex="-1">
    <!-- Contenido del modal igual que antes -->
</div>

<div class="modal fade" id="reportModal" tabindex="-1">
    <!-- Contenido del modal igual que antes -->
</div>

<%- include('partials/footer', { jsFile: 'chat.js' }) %>
<%- include('partials/header', { 
    title: 'Chat - Artícora', 
    currentPage: 'chat',
    cssFile: 'chat.css'
}) %>

<div class="chat-app">
    <div class="chat-container">
        <!-- Sidebar izquierdo -->
        <div class="chat-sidebar">
            <!-- Perfil del usuario -->
            <div class="user-profile">
                <div class="d-flex align-items-center">
                    <div class="avatar-container me-3">
                        <img src="<%= data.user.avatar %>" alt="Avatar" class="avatar">
                        <span class="status-indicator <%= data.user.status %>"></span>
                    </div>
                    <div class="user-info flex-grow-1">
                        <h6 class="mb-0 fw-bold"><%= data.user.name %></h6>
                        <small class="text-muted d-flex align-items-center">
                            <span class="badge <%= data.user.type === 'validated' ? 'bg-success' : 'bg-secondary' %> me-1">
                                <i class="fas fa-<%= data.user.type === 'validated' ? 'shield-alt' : 'user' %>"></i>
                            </span>
                            <%= data.user.type === 'validated' ? 'Validado' : 'Registrado' %>
                        </small>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" id="newChatBtn" title="Nuevo chat">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
                
                <!-- Límites -->
                <div class="limits mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">
                            <i class="fas fa-file-upload me-1"></i>
                            Archivos: <span class="fw-bold"><%= data.user.fileUploadsThisWeek %>/<%= data.user.fileUploadLimit %></span>
                        </small>
                        <div class="progress" style="width: 80px; height: 4px;">
                            <div class="progress-bar bg-info" style="width: <%= (data.user.fileUploadsThisWeek / data.user.fileUploadLimit * 100) %>%"></div>
                        </div>
                    </div>
                    <% if (data.user.canCreateGroups) { %>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="fas fa-users me-1"></i>
                            Grupos: <span class="fw-bold"><%= data.user.currentGroups %>/<%= data.user.maxGroups %></span>
                        </small>
                    </div>
                    <% } %>
                </div>
            </div>

            <!-- Búsqueda -->
            <div class="sidebar-search">
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="fas fa-search text-muted"></i>
                    </span>
                    <input type="text" class="form-control border-start-0" placeholder="Buscar chats...">
                </div>
            </div>

            <!-- Pestañas -->
            <div class="sidebar-tabs">
                <button class="tab-btn active" data-tab="chats">
                    <i class="fas fa-comments"></i>
                    <span>Chats</span>
                </button>
                <button class="tab-btn" data-tab="groups">
                    <i class="fas fa-users"></i>
                    <span>Grupos</span>
                </button>
                <button class="tab-btn" data-tab="requests">
                    <i class="fas fa-user-plus"></i>
                    <span>Solicitudes</span>
                    <% if (data.incomingRequests.length > 0) { %>
                    <span class="badge bg-danger ms-2"><%= data.incomingRequests.length %></span>
                    <% } %>
                </button>
            </div>

            <!-- Lista de chats -->
            <div class="chats-list">
                <!-- Chats activos -->
                <div class="tab-content active" id="chats-content">
                    <% data.contacts.forEach(contact => { 
                        const isActive = contact.id === data.activeChat.id && data.activeChat.type === 'individual';
                    %>
                    <div class="chat-item <%= isActive ? 'active' : '' %>" 
                         data-id="<%= contact.id %>" 
                         data-type="<%= contact.type === 'channel' ? 'channel' : 'individual' %>"
                         data-is-request="<%= !contact.isContact %>">
                        <div class="d-flex align-items-center">
                            <div class="avatar-container me-3">
                                <img src="<%= contact.avatar %>" alt="Avatar" class="avatar-sm">
                                <% if (contact.type !== 'channel') { %>
                                <span class="status-indicator <%= contact.status %>"></span>
                                <% } %>
                            </div>
                            <div class="chat-info flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center">
                                    <strong class="chat-name"><%= contact.name %></strong>
                                    <% if (contact.unread > 0) { %>
                                    <span class="badge bg-primary rounded-pill"><%= contact.unread %></span>
                                    <% } %>
                                </div>
                                <small class="text-muted d-block">
                                    <% if (contact.type === 'channel') { %>
                                    <i class="fas fa-bullhorn me-1"></i>Canal oficial
                                    <% } else if (!contact.isContact) { %>
                                    <i class="fas fa-clock me-1"></i>Solicitud enviada
                                    <% } else { %>
                                    <span class="badge <%= contact.type === 'validated' ? 'bg-success' : 'bg-secondary' %> me-1">
                                        <%= contact.type === 'validated' ? 'V' : 'R' %>
                                    </span>
                                    <%= contact.lastSeen %>
                                    <% } %>
                                </small>
                            </div>
                        </div>
                    </div>
                    <% }) %>
                </div>

                <!-- Grupos -->
                <div class="tab-content" id="groups-content">
                    <% if (data.user.canCreateGroups) { %>
                    <div class="mb-3">
                        <button class="btn btn-primary w-100 btn-sm" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                            <i class="fas fa-plus-circle me-2"></i> Nuevo grupo
                        </button>
                    </div>
                    <% } %>
                    
                    <% data.groups.filter(g => g.isMember).forEach(group => { 
                        const isActive = group.id === data.activeChat.id && data.activeChat.type === 'group';
                    %>
                    <div class="chat-item <%= isActive ? 'active' : '' %>" data-id="<%= group.id %>" data-type="group">
                        <div class="d-flex align-items-center">
                            <img src="<%= group.avatar %>" alt="Avatar" class="avatar-sm rounded-circle me-3">
                            <div class="chat-info flex-grow-1">
                                <strong class="chat-name"><%= group.name %></strong>
                                <small class="text-muted d-block">
                                    <i class="fas fa-users me-1"></i>
                                    <%= group.members %>/<%= group.maxMembers %> miembros
                                    <% if (group.lastMessage) { %>
                                    • <strong><%= group.lastMessage.sender %>:</strong> <%= group.lastMessage.text %>
                                    <% } %>
                                </small>
                            </div>
                        </div>
                    </div>
                    <% }) %>
                </div>

                <!-- Solicitudes entrantes -->
                <div class="tab-content" id="requests-content">
                    <% if (data.incomingRequests.length === 0) { %>
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-2x text-muted mb-3"></i>
                        <p class="text-muted mb-0">No hay solicitudes pendientes</p>
                    </div>
                    <% } else { %>
                    <% data.incomingRequests.forEach(request => { %>
                    <div class="request-item" data-id="<%= request.id %>" data-type="request">
                        <div class="d-flex align-items-center">
                            <img src="<%= request.avatar %>" alt="Avatar" class="avatar-sm rounded-circle me-3">
                            <div class="request-info flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center">
                                    <strong><%= request.name %></strong>
                                    <small class="text-muted"><%= request.time %></small>
                                </div>
                                <p class="request-message mb-1"><%= request.message %></p>
                                <div class="request-actions">
                                    <button class="btn btn-sm btn-success accept-btn">
                                        <i class="fas fa-check"></i> Aceptar
                                    </button>
                                    <button class="btn btn-sm btn-danger reject-btn">
                                        <i class="fas fa-times"></i> Rechazar
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary report-btn">
                                        <i class="fas fa-flag"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <% }) %>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Área principal del chat -->
        <div class="chat-main">
            <!-- Encabezado del chat -->
            <div class="chat-header" id="chatHeader">
                <div class="d-flex align-items-center">
                    <% if (data.activeChat.type === 'individual' || data.activeChat.type === 'channel') { 
                        const contact = data.contacts.find(c => c.id === data.activeChat.id);
                    %>
                    <div class="avatar-container me-3">
                        <img src="<%= contact ? contact.avatar : data.activeChat.avatar %>" alt="Avatar" class="avatar">
                        <% if (data.activeChat.type === 'individual') { %>
                        <span class="status-indicator <%= data.activeChat.status %>"></span>
                        <% } %>
                    </div>
                    <div>
                        <h5 class="mb-0" id="chatName"><%= data.activeChat.name %></h5>
                        <small class="text-muted" id="chatStatus">
                            <% if (data.activeChat.type === 'channel') { %>
                            <i class="fas fa-bullhorn me-1"></i>Canal oficial
                            <% } else if (data.activeChat.isRequest) { %>
                            <i class="fas fa-clock me-1"></i>Solicitud pendiente
                            <% } else { %>
                            <% if (data.activeChat.encryption) { %>
                            <i class="fas fa-lock text-success me-1"></i>
                            <% } %>
                            <%= data.activeChat.status === 'online' ? 'En línea' : 'Desconectado' %>
                            <% } %>
                        </small>
                    </div>
                    <% } else if (data.activeChat.type === 'group') { %>
                    <div class="me-3">
                        <i class="fas fa-users fa-2x text-primary"></i>
                    </div>
                    <div>
                        <h5 class="mb-0" id="chatName"><%= data.activeChat.name %></h5>
                        <small class="text-muted" id="chatStatus">
                            <i class="fas fa-users me-1"></i>Grupo académico
                        </small>
                    </div>
                    <% } %>
                </div>
                
                <div class="chat-actions" id="chatActions">
                    <% if (!data.activeChat.isRequest && data.activeChat.type !== 'channel') { %>
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Información">
                        <i class="fas fa-info-circle"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#reportModal">
                        <i class="fas fa-flag"></i>
                    </button>
                    <% } else if (data.activeChat.type === 'channel') { %>
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Información">
                        <i class="fas fa-info-circle"></i>
                    </button>
                    <% } %>
                </div>
            </div>

            <!-- Área de mensajes -->
            <div class="messages-container" id="messagesContainer">
                <% if (data.activeChat.type === 'channel') { %>
                <!-- Canal Artícora -->
                <div class="channel-welcome">
                    <div class="text-center mb-4">
                        <i class="fas fa-bullhorn fa-3x text-warning mb-3"></i>
                        <h4>Canal oficial Artícora</h4>
                        <p class="text-muted">Anuncios y notificaciones importantes</p>
                    </div>
                    
                    <% data.articoraMessages.forEach(message => { %>
                    <div class="channel-message <%= message.isAnnouncement ? 'announcement' : '' %>">
                        <div class="d-flex">
                            <div class="message-icon me-3">
                                <i class="fas fa-<%= message.isAnnouncement ? 'bullhorn' : 'info-circle' %> fa-lg
                                    <%= message.isAnnouncement ? 'text-warning' : 'text-info' %>"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <strong><%= message.sender %></strong>
                                    <small class="text-muted"><%= message.time %></small>
                                </div>
                                <p class="mb-0"><%= message.text %></p>
                            </div>
                        </div>
                    </div>
                    <% }) %>
                </div>
                
                <% } else if (data.activeChat.isRequest) { 
                    const contact = data.contacts.find(c => c.id === data.activeChat.id);
                %>
                <!-- Solicitud pendiente (yo envié) -->
                <div class="request-chat-view">
                    <div class="text-center py-4">
                        <img src="<%= contact.avatar %>" alt="Avatar" class="avatar-lg rounded-circle mb-3">
                        <h4><%= contact.name %></h4>
                        <p class="text-muted mb-4">
                            <span class="badge <%= contact.type === 'validated' ? 'bg-success' : 'bg-secondary' %>">
                                <%= contact.type === 'validated' ? 'Validado' : 'Registrado' %>
                            </span>
                            <span class="ms-2">Última conexión: <%= contact.lastSeen %></span>
                        </p>
                        
                        <div class="card border-warning mb-4">
                            <div class="card-header bg-warning bg-opacity-10">
                                <i class="fas fa-paper-plane me-2"></i>Tu solicitud de contacto
                            </div>
                            <div class="card-body">
                                <p class="mb-0"><%= contact.requestMessage %></p>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Esperando respuesta. No puedes enviar mensajes hasta que acepten tu solicitud.
                        </div>
                    </div>
                </div>
                
                <% } else { %>
                <!-- Chat normal -->
                <% data.activeChat.messages.forEach(message => { %>
                <div class="message <%= message.isOwn ? 'own' : '' %>">
                    <div class="message-content">
                        <% if (!message.isOwn && data.activeChat.type === 'group') { %>
                        <small class="message-sender"><%= message.sender %></small>
                        <% } %>
                        
                        <div class="message-bubble">
                            <p class="mb-0"><%= message.text %></p>
                        </div>
                        
                        <div class="message-footer">
                            <small class="text-muted"><%= message.time %></small>
                            <% if (message.isOwn) { %>
                            <div class="message-status">
                                <% if (message.status === 'sent') { %>
                                <i class="fas fa-check text-muted"></i>
                                <% } else if (message.status === 'delivered') { %>
                                <i class="fas fa-check-double text-muted"></i>
                                <% } else if (message.status === 'read') { %>
                                <i class="fas fa-check-double text-primary"></i>
                                <% } %>
                            </div>
                            <% } %>
                        </div>
                    </div>
                </div>
                <% }) %>
                
                <!-- Indicador de cifrado -->
                <div class="encryption-notice">
                    <i class="fas fa-lock text-success me-2"></i>
                    <small class="text-muted">
                        Cifrado de extremo a extremo activo (AES-256 & RSA-2048)
                    </small>
                </div>
                <% } %>
            </div>

            <!-- Área de entrada -->
            <div class="message-input-area" id="messageInputArea">
                <% if (data.activeChat.type === 'channel') { %>
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Este es un canal de solo lectura. Solo los administradores pueden publicar anuncios.
                </div>
                <% } else if (data.activeChat.isRequest) { %>
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    No puedes enviar mensajes hasta que acepten tu solicitud de contacto.
                </div>
                <% } else { %>
                <form id="messageForm">
                    <div class="input-group">
                        <textarea class="form-control" id="messageInput" 
                                  placeholder="Escribe tu mensaje..." 
                                  rows="1"></textarea>
                        
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-secondary" 
                                    data-bs-toggle="modal" data-bs-target="#uploadModal"
                                    data-bs-toggle="tooltip" title="Adjuntar archivo">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="input-info mt-2">
                        <small class="text-muted">
                            <i class="fas fa-shield-alt me-1"></i>
                            Cifrado de extremo a extremo activo
                        </small>
                        <small class="text-muted">
                            <i class="fas fa-file-upload me-1"></i>
                            Límite: 5MB por archivo
                        </small>
                    </div>
                </form>
                <% } %>
            </div>
        </div>
    </div>
</div>

<!-- Modales (se mantienen igual) -->
<div class="modal fade" id="createGroupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-users me-2"></i>Crear nuevo grupo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createGroupForm">
                    <div class="mb-3">
                        <label class="form-label">Nombre del grupo</label>
                        <input type="text" class="form-control" 
                               placeholder="Ej: Grupo de Investigación en IA" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-control" rows="3" 
                                  placeholder="Describe el propósito del grupo..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Seleccionar contactos (máx. 11)</label>
                        <div class="form-control" style="height: 150px; overflow-y: auto;">
                            <% data.contacts.filter(c => c.isContact && c.type !== 'channel').forEach(contact => { %>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       id="contact_<%= contact.id %>" value="<%= contact.id %>">
                                <label class="form-check-label" for="contact_<%= contact.id %>">
                                    <%= contact.name %>
                                    <small class="text-muted">(<%= contact.type === 'validated' ? 'Validado' : 'Registrado' %>)</small>
                                </label>
                            </div>
                            <% }) %>
                        </div>
                        <small class="text-muted">Límite: 12 miembros incluyéndote</small>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Como usuario validado, puedes crear hasta <%= data.user.maxGroups %> grupos.
                        Actualmente tienes <%= data.user.currentGroups %> grupos.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary" form="createGroupForm">Crear grupo</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-paperclip me-2"></i>Adjuntar archivo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="uploadForm">
                    <div class="mb-3">
                        <label class="form-label">Seleccionar archivo</label>
                        <input type="file" class="form-control" id="fileInput" required>
                        <div class="form-text">
                            Formatos permitidos:
                            <div class="d-flex flex-wrap gap-2 mt-2">
                                <% data.fileFormats.forEach(format => { %>
                                    <span class="badge" style="background-color: '<%= format.color %>'">
                                    <i class="fas fa-<%= format.icon %> me-1"></i>.<%= format.ext %>
                                </span>
                                <% }) %>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Tamaño máximo: 5MB</label>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar" id="fileSizeProgress" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="fileSizeText">0 MB / 5 MB</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Mensaje opcional</label>
                        <textarea class="form-control" rows="3" 
                                  placeholder="Añade un mensaje descriptivo..."></textarea>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Límite semanal: <%= data.user.fileUploadsThisWeek %>/<%= data.user.fileUploadLimit %> archivos.
                        El período se reinicia cada domingo.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary" form="uploadForm">Enviar archivo</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-flag me-2"></i>Reportar contenido
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reportForm">
                    <div class="mb-3">
                        <label class="form-label">Seleccionar razón</label>
                        <select class="form-select" required>
                            <option value="">Seleccionar una razón...</option>
                            <% data.reportReasons.forEach(reason => { %>
                            <option value="<%= reason %>"><%= reason %></option>
                            <% }) %>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Descripción adicional</label>
                        <textarea class="form-control" rows="4" 
                                  placeholder="Proporciona detalles adicionales..."></textarea>
                        <div class="form-text">
                            Tu reporte será revisado por nuestro equipo de moderación.
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-shield-alt me-2"></i>
                        Los reportes son confidenciales y se procesan dentro de las 24-48 horas.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-danger" form="reportForm">Enviar reporte</button>
            </div>
        </div>
    </div>
</div>

<script id="chatData" type="application/json">
  <%- JSON.stringify({
    user: data.user,
    contacts: data.contacts,
    groups: data.groups,
    incomingRequests: data.incomingRequests,
    articoraMessages: data.articoraMessages,
    fileFormats: data.fileFormats,
    reportReasons: data.reportReasons,
    activeChat: data.activeChat
  }) %>
</script>

<script>
  const chatDataElement = document.getElementById('chatData');
  window.chatData = JSON.parse(chatDataElement.textContent);

  window.currentUser = window.chatData.user;
  window.currentChat = window.chatData.activeChat;

  console.log('Datos del chat cargados:', window.chatData);
</script>


<%- include('partials/footer', { jsFile: 'chat.js' }) %>
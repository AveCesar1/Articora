<%- include('partials/header', { 
    title: 'Búsqueda - Artícora', 
    currentPage: 'search', 
    cssFile: 'search.css',
    searchQuery: typeof query !== 'undefined' ? query : ''
}) %>

<div class="container py-4">
    <!-- Encabezado de búsqueda -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="page-title mb-3">
                <i class="fas fa-search me-3"></i>Explorar Fuentes Académicas
            </h1>
            
            <!-- Barra de búsqueda principal -->
            <div class="search-box-container mb-4">
                <form action="/search" method="GET" class="search-form">
                    <div class="input-group input-group-lg">
                        <input type="text" class="form-control" name="q" 
                               placeholder="Buscar por título, autor, palabras clave..." 
                               value="<%= typeof query !== 'undefined' ? query : '' %>"
                               aria-label="Término de búsqueda">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-search me-2"></i> Buscar
                        </button>
                    </div>
                    
                    <!-- Filtros rápidos -->
                    <div class="mt-3 d-flex flex-wrap gap-2">
                        <span class="text-muted me-2">Filtrar por:</span>
                        <a href="?q=<%= typeof query !== 'undefined' ? encodeURIComponent(query) : '' %>&type=article" 
                           class="badge <%= typeof filters !== 'undefined' && filters.type === 'article' ? 'bg-primary' : 'bg-light text-dark' %>">
                            Artículos
                        </a>
                        <a href="?q=<%= typeof query !== 'undefined' ? encodeURIComponent(query) : '' %>&type=book" 
                           class="badge <%= typeof filters !== 'undefined' && filters.type === 'book' ? 'bg-primary' : 'bg-light text-dark' %>">
                            Libros
                        </a>
                        <a href="?q=<%= typeof query !== 'undefined' ? encodeURIComponent(query) : '' %>&type=thesis" 
                           class="badge <%= typeof filters !== 'undefined' && filters.type === 'thesis' ? 'bg-primary' : 'bg-light text-dark' %>">
                            Tesis
                        </a>
                        <a href="?q=<%= typeof query !== 'undefined' ? encodeURIComponent(query) : '' %>&sort=recent" 
                           class="badge <%= typeof filters !== 'undefined' && filters.sort === 'recent' ? 'bg-primary' : 'bg-light text-dark' %>">
                            Más recientes
                        </a>
                        <a href="?q=<%= typeof query !== 'undefined' ? encodeURIComponent(query) : '' %>&sort=rating" 
                           class="badge <%= typeof filters !== 'undefined' && filters.sort === 'rating' ? 'bg-primary' : 'bg-light text-dark' %>">
                            Mejor calificados
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Columna izquierda: Filtros avanzados -->
        <div class="col-lg-3 mb-4">
            <div class="sticky-top" style="top: 20px;">
                <!-- Botón para colapsar filtros en móvil -->
                <button class="btn btn-outline-primary w-100 mb-3 d-lg-none" 
                        type="button" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#filtersCollapse">
                    <i class="fas fa-filter me-2"></i> Mostrar/Ocultar Filtros
                </button>

                <!-- Contenedor de filtros -->
                <div class="collapse d-lg-block" id="filtersCollapse">
                    <div class="card shadow-sm filters-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-sliders-h me-2"></i>Filtros Avanzados
                            </h5>
                        </div>
                        
                        <div class="card-body">
                            <!-- Modo Ajuste a Grado Académico -->
                            <div class="mb-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" 
                                           id="academicAdjustment" 
                                           <%= typeof filters !== 'undefined' && filters.academicAdjustment ? 'checked' : '' %>>
                                    <label class="form-check-label" for="academicAdjustment">
                                        <strong>Ajustar a mi grado académico</strong>
                                    </label>
                                </div>
                                <div class="form-text small">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Prioriza fuentes evaluadas por usuarios de tu nivel académico.
                                </div>
                            </div>

                            <hr class="my-4">

                            <!-- Filtros por Categorías -->
                            <div class="mb-4">
                                <h6 class="filter-section-title">
                                    <i class="fas fa-folder-open me-2"></i>Categorías del Conocimiento
                                </h6>
                                <div class="categories-filter">
                                    <% categories.forEach(category => { %>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input category-checkbox" 
                                                   type="checkbox" 
                                                   id="cat_<%= category.id %>"
                                                   value="<%= category.id %>"
                                                   <%= typeof filters !== 'undefined' && filters.categories && filters.categories.includes(category.id) ? 'checked' : '' %>>
                                            <label class="form-check-label" for="cat_<%= category.id %>">
                                                <span class="category-badge-small me-2" 
                                                      style="background-color: <%= category.color %>"></span>
                                                <%= category.name %>
                                            </label>
                                            
                                            <!-- Subcategorías (mostrar solo si la categoría está seleccionada) -->
                                            <div class="subcategories-container mt-2 ms-4" 
                                                 id="subcat_<%= category.id %>" 
                                                 style="display: none;">
                                                <% category.subcategories.forEach(subcat => { %>
                                                    <div class="form-check mb-1">
                                                        <input class="form-check-input subcategory-checkbox" 
                                                               type="checkbox" 
                                                               id="subcat_<%= subcat.id %>"
                                                               value="<%= subcat.id %>"
                                                               data-category="<%= category.id %>"
                                                               <%= typeof filters !== 'undefined' && filters.subcategories && filters.subcategories.includes(subcat.id) ? 'checked' : '' %>>
                                                        <label class="form-check-label small" for="subcat_<%= subcat.id %>">
                                                            <%= subcat.name %>
                                                        </label>
                                                    </div>
                                                <% }) %>
                                            </div>
                                        </div>
                                    <% }) %>
                                </div>
                            </div>

                            <hr class="my-4">

                            <!-- Filtros por Calificación -->
                            <div class="mb-4">
                                <h6 class="filter-section-title">
                                    <i class="fas fa-star me-2"></i>Calificación Comunitaria
                                </h6>
                                
                                <!-- Calificación promedio -->
                                <div class="mb-3">
                                    <label class="form-label small">Calificación promedio</label>
                                    <div class="range-slider-container">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="range-value" id="avgRatingValue">
                                                <%= typeof filters !== 'undefined' && filters.ratingMin ? filters.ratingMin : 0 %> - 
                                                <%= typeof filters !== 'undefined' && filters.ratingMax ? filters.ratingMax : 5 %>
                                            </span>
                                            <span class="text-muted">0-5</span>
                                        </div>
                                        <div class="range-slider" id="avgRatingSlider"></div>
                                    </div>
                                </div>

                                <!-- Calificaciones por criterio -->
                                <div class="criteria-filters">
                                    <% ratingCriteria.forEach(criterion => { %>
                                        <div class="mb-3">
                                            <label class="form-label small">
                                                <span class="text-primary"><%= criterion.name %></span>
                                            </label>
                                            <div class="range-slider-container">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span class="range-value" id="<%= criterion.id %>Value">
                                                        <%= typeof filters !== 'undefined' && filters[criterion.id + 'Min'] ? filters[criterion.id + 'Min'] : 0 %> - 
                                                        <%= typeof filters !== 'undefined' && filters[criterion.id + 'Max'] ? filters[criterion.id + 'Max'] : 5 %>
                                                    </span>
                                                    <span class="text-muted">0-5</span>
                                                </div>
                                                <div class="range-slider" id="<%= criterion.id %>Slider"></div>
                                            </div>
                                        </div>
                                    <% }) %>
                                </div>
                            </div>

                            <hr class="my-4">

                            <!-- Filtros adicionales -->
                            <div class="mb-4">
                                <h6 class="filter-section-title">
                                    <i class="fas fa-cog me-2"></i>Otros Filtros
                                </h6>
                                
                                <!-- Tipo de fuente -->
                                <div class="mb-3">
                                    <label class="form-label small">Tipo de fuente</label>
                                    <select class="form-select form-select-sm" id="sourceTypeFilter">
                                        <option value="">Todos los tipos</option>
                                        <% sourceTypes.forEach(type => { %>
                                            <option value="<%= type.value %>" 
                                                    <%= typeof filters !== 'undefined' && filters.sourceType === type.value ? 'selected' : '' %>>
                                                <%= type.label %>
                                            </option>
                                        <% }) %>
                                    </select>
                                </div>

                                <!-- Año de publicación -->
                                <div class="mb-3">
                                    <label class="form-label small">Año de publicación</label>
                                    <div class="row g-2">
                                        <div class="col">
                                            <input type="number" class="form-control form-control-sm" 
                                                   id="yearFrom" placeholder="Desde" 
                                                   min="1900" max="<%= new Date().getFullYear() %>"
                                                   value="<%= typeof filters !== 'undefined' && filters.yearFrom ? filters.yearFrom : '' %>">
                                        </div>
                                        <div class="col">
                                            <input type="number" class="form-control form-control-sm" 
                                                   id="yearTo" placeholder="Hasta"
                                                   min="1900" max="<%= new Date().getFullYear() %>"
                                                   value="<%= typeof filters !== 'undefined' && filters.yearTo ? filters.yearTo : '' %>">
                                        </div>
                                    </div>
                                </div>

                                <!-- Ordenamiento -->
                                <div class="mb-3">
                                    <label class="form-label small">Ordenar por</label>
                                    <select class="form-select form-select-sm" id="sortBy">
                                        <option value="relevance" 
                                                <%= typeof filters !== 'undefined' && filters.sortBy === 'relevance' ? 'selected' : '' %>>
                                            Relevancia
                                        </option>
                                        <option value="rating" 
                                                <%= typeof filters !== 'undefined' && filters.sortBy === 'rating' ? 'selected' : '' %>>
                                            Calificación
                                        </option>
                                        <option value="recent" 
                                                <%= typeof filters !== 'undefined' && filters.sortBy === 'recent' ? 'selected' : '' %>>
                                            Más recientes
                                        </option>
                                        <option value="popular" 
                                                <%= typeof filters !== 'undefined' && filters.sortBy === 'popular' ? 'selected' : '' %>>
                                            Más populares
                                        </option>
                                        <option value="difficulty" 
                                                <%= typeof filters !== 'undefined' && filters.sortBy === 'difficulty' ? 'selected' : '' %>>
                                            Dificultad técnica
                                        </option>
                                    </select>
                                </div>
                            </div>

                            <!-- Botones de acción -->
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-primary" id="applyFiltersBtn">
                                    <i class="fas fa-check me-2"></i> Aplicar Filtros
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="resetFiltersBtn">
                                    <i class="fas fa-redo me-2"></i> Restablecer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna derecha: Resultados de búsqueda -->
        <div class="col-lg-9">
            <!-- Información de resultados -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h5 class="mb-0">
                        <%= results.length %> resultado<%= results.length !== 1 ? 's' : '' %> 
                        <% if (typeof query !== 'undefined' && query) { %>
                            para "<strong><%= query %></strong>"
                        <% } %>
                    </h5>
                    <% if (typeof filters !== 'undefined' && Object.keys(filters).length > 0) { %>
                        <p class="text-muted small mb-0">
                            <i class="fas fa-filter me-1"></i>
                            Filtros activos
                        </p>
                    <% } %>
                </div>
                
                <!-- Vista de resultados -->
                <div class="d-flex align-items-center">
                    <span class="me-2 small text-muted">Vista:</span>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary active" id="viewListBtn">
                            <i class="fas fa-list"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="viewGridBtn">
                            <i class="fas fa-th-large"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lista de resultados -->
            <div id="searchResults">
                <% if (results.length > 0) { %>
                    <div class="results-list">
                        <% results.forEach(source => { %>
                            <div class="card source-card mb-3">
                                <div class="card-body">
                                    <div class="row">
                                        <!-- Información principal -->
                                        <div class="col-md-8">
                                            <!-- Título y enlace -->
                                            <h5 class="source-title mb-2">
                                                <a href="/post/<%= source.id %>" class="text-decoration-none">
                                                    <%= source.title %>
                                                </a>
                                            </h5>
                                            
                                            <!-- Autores -->
                                            <p class="source-authors mb-2">
                                                <i class="fas fa-user-edit me-1"></i>
                                                <span class="text-muted">
                                                    <%= source.authors.join(', ') %>
                                                </span>
                                            </p>
                                            
                                            <!-- Metadatos -->
                                            <div class="source-metadata mb-3">
                                                <span class="badge <%= source.type === 'Artículo de revista' ? 'bg-primary' : source.type === 'Libro' ? 'bg-success' : 'bg-secondary' %> me-2">
                                                    <%= source.type %>
                                                </span>
                                                <span class="text-muted me-3">
                                                    <i class="far fa-calendar me-1"></i><%= source.year %>
                                                </span>
                                                <span class="text-muted me-3">
                                                    <i class="far fa-file me-1"></i><%= source.pages %>
                                                </span>
                                                <% if (source.doi) { %>
                                                    <span class="text-muted">
                                                        <i class="fas fa-link me-1"></i>DOI
                                                    </span>
                                                <% } %>
                                            </div>
                                            
                                            <!-- Palabras clave -->
                                            <% if (source.keywords && source.keywords.length > 0) { %>
                                                <div class="source-keywords mb-3">
                                                    <% source.keywords.slice(0, 5).forEach(keyword => { %>
                                                        <span class="badge bg-light text-dark me-1 mb-1">
                                                            <i class="fas fa-hashtag me-1"></i><%= keyword %>
                                                        </span>
                                                    <% }) %>
                                                </div>
                                            <% } %>
                                            
                                            <!-- Extracto/resumen -->
                                            <p class="source-excerpt mb-0">
                                                <%= source.excerpt.length > 200 ? source.excerpt.substring(0, 200) + '...' : source.excerpt %>
                                            </p>
                                        </div>
                                        
                                        <!-- Información secundaria -->
                                        <div class="col-md-4">
                                            <!-- Calificación -->
                                            <div class="source-rating mb-3">
                                                <div class="d-flex align-items-center mb-2">
                                                    <div class="rating-stars">
                                                        <% for (let i = 1; i <= 5; i++) { %>
                                                            <% if (i <= Math.floor(source.rating.average)) { %>
                                                                <i class="fas fa-star text-warning"></i>
                                                            <% } else if (i === Math.ceil(source.rating.average) && source.rating.average % 1 !== 0) { %>
                                                                <i class="fas fa-star-half-alt text-warning"></i>
                                                            <% } else { %>
                                                                <i class="far fa-star text-warning"></i>
                                                            <% } %>
                                                        <% } %>
                                                    </div>
                                                    <strong class="ms-2"><%= source.rating.average.toFixed(1) %></strong>
                                                    <span class="text-muted ms-1">(<%= source.rating.count %>)</span>
                                                </div>
                                            </div>
                                            
                                            <!-- Categorías -->
                                            <div class="source-categories mb-3">
                                                <div class="d-flex align-items-center mb-1">
                                                    <i class="fas fa-folder me-2 text-primary"></i>
                                                    <span class="badge" style="background-color: <%= source.category.color %>">
                                                        <%= source.category.name %>
                                                    </span>
                                                </div>
                                                <div class="ms-4">
                                                    <span class="badge bg-light text-dark">
                                                        <%= source.subcategory.name %>
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <!-- Estadísticas -->
                                            <div class="source-stats small">
                                                <div class="d-flex justify-content-between text-muted">
                                                    <span><i class="far fa-eye me-1"></i> <%= source.stats.views %> vistas</span>
                                                    <span><i class="far fa-bookmark me-1"></i> <%= source.stats.bookmarks %> guardados</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Footer de la tarjeta -->
                                <div class="card-footer bg-transparent">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="text-muted small">
                                            <i class="far fa-clock me-1"></i>
                                            Subido el <%= source.uploadDate %> por 
                                            <a href="/profile/<%= source.uploader.id %>" class="text-decoration-none">
                                                <%= source.uploader.name %>
                                            </a>
                                        </div>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-outline-primary btn-sm">
                                                <i class="far fa-bookmark me-1"></i> Guardar
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm">
                                                <i class="far fa-star me-1"></i> Calificar
                                            </button>
                                            <button type="button" class="btn btn-outline-info btn-sm">
                                                <i class="fas fa-quote-right me-1"></i> Citar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                    
                    <!-- Paginación -->
                    <% if (pagination && pagination.totalPages > 1) { %>
                        <nav aria-label="Paginación de resultados">
                            <ul class="pagination justify-content-center">
                                <li class="page-item <%= pagination.currentPage === 1 ? 'disabled' : '' %>">
                                    <a class="page-link" href="?page=<%= pagination.currentPage - 1 %>">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                </li>
                                
                                <% for (let i = 1; i <= pagination.totalPages; i++) { %>
                                    <% if (i === pagination.currentPage) { %>
                                        <li class="page-item active">
                                            <span class="page-link"><%= i %></span>
                                        </li>
                                    <% } else if (
                                        i === 1 || 
                                        i === pagination.totalPages || 
                                        (i >= pagination.currentPage - 2 && i <= pagination.currentPage + 2)
                                    ) { %>
                                        <li class="page-item">
                                            <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                                        </li>
                                    <% } else if (
                                        i === pagination.currentPage - 3 || 
                                        i === pagination.currentPage + 3
                                    ) { %>
                                        <li class="page-item disabled">
                                            <span class="page-link">...</span>
                                        </li>
                                    <% } %>
                                <% } %>
                                
                                <li class="page-item <%= pagination.currentPage === pagination.totalPages ? 'disabled' : '' %>">
                                    <a class="page-link" href="?page=<%= pagination.currentPage + 1 %>">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    <% } %>
                <% } else { %>
                    <!-- Sin resultados -->
                    <div class="card shadow-sm">
                        <div class="card-body text-center py-5">
                            <div class="empty-state-icon mb-4">
                                <i class="fas fa-search fa-3x text-muted"></i>
                            </div>
                            <h4 class="mb-3">No se encontraron resultados</h4>
                            <p class="text-muted mb-4">
                                <% if (typeof query !== 'undefined' && query) { %>
                                    No hay fuentes que coincidan con "<strong><%= query %></strong>".
                                <% } else { %>
                                    No hay fuentes que coincidan con los filtros seleccionados.
                                <% } %>
                            </p>
                            <div class="d-flex justify-content-center gap-3">
                                <button class="btn btn-primary" id="resetFiltersEmptyBtn">
                                    <i class="fas fa-redo me-2"></i> Restablecer filtros
                                </button>
                                <a href="/" class="btn btn-outline-secondary">
                                    <i class="fas fa-home me-2"></i> Volver al inicio
                                </a>
                            </div>
                        </div>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
</div>

<%- include('partials/footer', { jsFile: 'search.js' }) %>